<story-context id="7-2-theme-manager-rename-merge-split" v="1.0">
  <metadata>
    <epicId>7</epicId>
    <storyId>2</storyId>
    <title>Theme Manager (Rename/Merge/Split)</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-12-14</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/7-2-theme-manager-rename-merge-split.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>Leader</asA>
    <iWant>to manage themes (rename/merge/split)</iWant>
    <soThat>themes become increasingly accurate for my niche over time</soThat>
    <tasks>
      <task id="1" status="pending">Extend Theme schema for history</task>
      <task id="2" status="pending">Create ThemeManagerService</task>
      <task id="3" status="pending">Extend ThemeService for history</task>
      <task id="4" status="pending">Add Theme management API endpoints</task>
      <task id="5" status="pending">Add rename functionality (frontend)</task>
      <task id="6" status="pending">Add merge functionality (frontend)</task>
      <task id="7" status="pending">Add split functionality (frontend)</task>
      <task id="8" status="pending">Add history view (frontend)</task>
      <task id="9" status="pending">Write backend tests</task>
      <task id="10" status="pending">Write frontend tests</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC1">Given themes exist, When the user renames a theme, Then the system updates the theme name and maintains all content associations.</criterion>
    <criterion id="AC2">Given two or more themes exist, When the user merges themes, Then the system combines them into one theme with all content from both and maintains traceability history.</criterion>
    <criterion id="AC3">Given a theme with multiple content items, When the user splits a theme, Then the system creates new themes based on user selection or automatic sub-clustering.</criterion>
    <criterion id="AC4">Given a theme operation (rename/merge/split), When the operation completes, Then the system logs the change in theme history for traceability.</criterion>
    <criterion id="AC5">Given theme history exists, When the user views theme details, Then they can see the history of changes (renames, merges, splits).</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>FR-021 (Growth)</section>
        <snippet>Theme manager: rename/merge/split. Hệ thống cập nhật mapping và giữ traceability lịch sử.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Epic 7: Story 7.2</section>
        <snippet>Story 7.2: Theme manager (rename/merge/split). User rename/merge/split, hệ thống cập nhật mapping và giữ traceability lịch sử.</snippet>
      </doc>
      <doc>
        <path>docs/stories/7-1-cluster-themes-from-captions-and-hashtags.md</path>
        <title>Story 7.1 Reference</title>
        <section>Dev Notes</section>
        <snippet>Theme schema and ThemeService defined in Story 7.1. This story extends with management operations and history.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>libraries/nestjs-libraries/src/database/prisma/themes/theme.service.ts</path>
        <kind>service</kind>
        <symbol>ThemeService</symbol>
        <reason>Base theme service to extend with history methods. Created in Story 7.1.</reason>
      </artifact>
      <artifact>
        <path>apps/backend/src/api/routes/themes.controller.ts</path>
        <kind>controller</kind>
        <symbol>ThemesController</symbol>
        <reason>Extend with management endpoints (PUT, POST merge/split). Created in Story 7.1.</reason>
      </artifact>
      <artifact>
        <path>apps/frontend/src/components/themes/theme-detail.page.tsx</path>
        <kind>component</kind>
        <symbol>ThemeDetailPage</symbol>
        <reason>Extend with history section and management actions. Created in Story 7.1.</reason>
      </artifact>
      <artifact>
        <path>apps/frontend/src/components/analytics/export/export-modal.component.tsx</path>
        <kind>component</kind>
        <symbol>ExportModal</symbol>
        <reason>Reference for modal patterns with form inputs and validation.</reason>
      </artifact>
    </code>
    <dependencies>
      <node>
        <package>@nestjs/common</package>
        <version>^10.0.0</version>
      </node>
      <node>
        <package>@prisma/client</package>
        <version>^6.5.0</version>
      </node>
      <node>
        <package>react</package>
        <version>^18.0.0</version>
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="dependency">Story 7.1 must be complete before implementing this story</constraint>
    <constraint type="architecture">Add ThemeHistory model to track all operations</constraint>
    <constraint type="architecture">Soft-delete merged themes (keep for history traceability)</constraint>
    <constraint type="api">PUT /api/themes/:id for rename, POST for merge/split actions</constraint>
    <constraint type="frontend">Use modals for merge and split operations</constraint>
    <constraint type="data">Log all operations with previousState and newState for audit trail</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>ThemeManagerService.renameTheme</name>
      <kind>service method</kind>
      <signature>renameTheme(themeId: string, newName: string): Promise&lt;Theme&gt;</signature>
      <path>libraries/nestjs-libraries/src/database/prisma/themes/theme-manager.service.ts</path>
    </interface>
    <interface>
      <name>ThemeManagerService.mergeThemes</name>
      <kind>service method</kind>
      <signature>mergeThemes(themeIds: string[], targetName: string): Promise&lt;Theme&gt;</signature>
      <path>libraries/nestjs-libraries/src/database/prisma/themes/theme-manager.service.ts</path>
    </interface>
    <interface>
      <name>ThemeManagerService.splitTheme</name>
      <kind>service method</kind>
      <signature>splitTheme(themeId: string, splitConfig: SplitConfig): Promise&lt;Theme[]&gt;</signature>
      <path>libraries/nestjs-libraries/src/database/prisma/themes/theme-manager.service.ts</path>
    </interface>
    <interface>
      <name>PUT /api/themes/:id</name>
      <kind>REST endpoint</kind>
      <signature>PUT /api/themes/:id - Rename theme</signature>
      <path>apps/backend/src/api/routes/themes.controller.ts</path>
    </interface>
    <interface>
      <name>POST /api/themes/merge</name>
      <kind>REST endpoint</kind>
      <signature>POST /api/themes/merge - Merge multiple themes</signature>
      <path>apps/backend/src/api/routes/themes.controller.ts</path>
    </interface>
    <interface>
      <name>POST /api/themes/:id/split</name>
      <kind>REST endpoint</kind>
      <signature>POST /api/themes/:id/split - Split theme into multiple</signature>
      <path>apps/backend/src/api/routes/themes.controller.ts</path>
    </interface>
    <interface>
      <name>GET /api/themes/:id/history</name>
      <kind>REST endpoint</kind>
      <signature>GET /api/themes/:id/history - Get theme change history</signature>
      <path>apps/backend/src/api/routes/themes.controller.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>Use Jest for unit tests. Test each operation independently. Verify history logging for all operations.</standards>
    <locations>
      <location>libraries/nestjs-libraries/src/database/prisma/themes/theme-manager.service.spec.ts</location>
      <location>apps/frontend/src/components/themes/merge-themes.modal.spec.tsx</location>
      <location>apps/frontend/src/components/themes/split-theme.modal.spec.tsx</location>
    </locations>
    <ideas>
      <idea acId="AC1">Test rename updates name and preserves content associations</idea>
      <idea acId="AC1">Test rename logs history with previous and new name</idea>
      <idea acId="AC2">Test merge combines content from all source themes</idea>
      <idea acId="AC2">Test merge soft-deletes source themes</idea>
      <idea acId="AC3">Test split creates new themes with selected content</idea>
      <idea acId="AC3">Test split updates original theme</idea>
      <idea acId="AC4">Test all operations log to ThemeHistory</idea>
      <idea acId="AC5">Test history retrieval returns chronological changes</idea>
    </ideas>
  </tests>
</story-context>
